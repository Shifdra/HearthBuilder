@using HearthBuilder.Models
@using System.Web.Optimization
@{
    ViewBag.Title = "Build a " + ViewData["class"] + " Deck";

    List<Card> allCards = Cards.Instance.AllCards;

    PlayerClass pClass = ((Deck)Session["deck"]).Class; //(PlayerClass)Enum.Parse(typeof(PlayerClass), (string)ViewData["class"], true);
    
}

<div data-ng-controller="BuildController" data-ng-init="init()" class="buildDeck">
    <script>
        var myapp = angular.module('myapp', ['ngSanitize']);
        myapp.controller("BuildController", function ($scope, $http, $compile) {

            // in controller

            $scope.txtSearch = {
                text: '',
                class: '@ViewData["className"]'
            };
            $scope.cardData = {};

            $scope.init = function () {
                var responsePromise = $http.get("/Build/ListCards/");

                responsePromise.success(function (data, status, headers, config) {
                    $scope.cardData = data;
                    $scope.filterCards();
                    $scope.refreshDeck();
                    //alert(data);
                });
                responsePromise.error(function (data, status, headers, config) {
                    alert("AJAX failed!");
                });
                // check if there is query in url
                // and fire search in case its value is not empty
            };

            $scope.addCardClick = function(item) {

                var id = item.currentTarget.getAttribute("data-id");
                var responsePromise = $http.get("/Build/AddCard/"+id+"/");

                responsePromise.success(function(data, status, headers, config) {
                    //$scope.myData.fromServer = data.message;
                    angular.forEach(data, function (result){
                        //alert("Ajax msg:" + result.Message);

                        if (result.Result == '1'){
                            //we added a card, lets update the Deck List
                            $scope.refreshDeck();
                        }
                        else {
                            alert("Error: " + result.Message);
                        }
                    });
                    
                });
                responsePromise.error(function(data, status, headers, config) {
                    alert("AJAX failed!" + data.Message);
                });
            }

            $scope.delCardClick = function(item) {

                var id = item.currentTarget.getAttribute("data-id");
                var responsePromise = $http.get("/Build/RemoveCard/"+id+"/");

                responsePromise.success(function(data, status, headers, config) {
                    angular.forEach(data, function (result){
                        //alert("Ajax msg:" + result.Message);

                        if (result.Result == '1'){
                            //we added a card, lets update the Deck List
                            $scope.refreshDeck();
                        }
                        else {
                            alert("Error: " + result.Message);
                        }
                    });
                    
                });
                responsePromise.error(function(data, status, headers, config) {
                    alert("AJAX failed!" + data.Message);
                });
            }

            $scope.saveDeckClick = function() {
                                
                var responsePromise = $http.get("/Build/SaveDeck/");
                responsePromise.success(function(data, status, headers, config) {
                    angular.forEach(data, function (result){
                        if (result.Result == '1'){
                            //we saved the deck successfully
                            $scope.refreshDeck();
                        }
                        else {
                            alert("Error: " + result.Message);
                        }
                    });
                    
                });
                responsePromise.error(function(data, status, headers, config) {
                    alert("AJAX failed!" + data.Message);
                });
            }

            
            $scope.deckList = "";
            $scope.refreshDeck = function() {
                var results = "";
                var responsePromise = $http.get("/Build/ListDeck/");
                responsePromise.success(function(data, status, headers, config) {
                    //$scope.myData.fromServer = data.message;
                    var count = 0;
                    angular.forEach(data.Cards, function (card){
                        var duplicateVisible = "";
                        var shouldHide = false;

                        //we don't want to show duplicate cards, instead we should show a counter beside the card
                        //so we loop through again, looking for another occurrance
                        var tmpCount = 0;
                        angular.forEach(data.Cards, function (tempCard){
                            if (card.Id == tempCard.Id && count != tmpCount) { //if we have duplicate cards
                                if (count < tmpCount) { //if were on the first occurance of the card
                                    duplicateVisible = "<span class='duplicate'>2</span>";
                                } else if (count > tmpCount) {  //if were on the 2nd occurance of the card
                                    shouldHide = true; //hide entire entry because the first has a counter
                                }
                            }
                                
                            tmpCount += 1;
                        });

                        if (!shouldHide)
                            results += "<div class='cardRow' ng-click='delCardClick($event)' data-id='" + card.Id + "'><div class='card' style=\"background-image: url('/Content/Images/bars/"+card.Id+".png');\"></div><div class='cardFrame'><span class='cardCost'>"+card.Cost+"</span><span class='cardName'>"+card.Name+"</span><span class='delCard'>Remove <i class='fa fa-times' aria-hidden='true'></i></span>"+duplicateVisible+"</div></div>";
                        
                        count += 1;
                    });

                    var element = angular.element(document.querySelector('.deckList'));
                    var generated = element.html(results);
                    $scope.deckList = $compile(generated.contents())($scope);
                    
                });
                responsePromise.error(function(data, status, headers, config) {
                    alert("AJAX failed!" + data.Message);
                });
            }

            $scope.filterCards = function () {

                var results = "";
                $scope.cardsResponse = "";

                console.log("Search: " + $scope.txtSearch.text);
                angular.forEach($scope.cardData, function (card) { //loop through every card
                    $scope.cardData.curCard = card; //assign the current card to the scope
                    //console.log($scope.cardData.curCard);
                    if ($scope.cardData.curCard.Class == @((int)pClass) || $scope.cardData.curCard.Class == 0){ //filter by current class, and non-class
                        if ($scope.cardData.curCard.Name.toLowerCase().indexOf($scope.txtSearch.text) > -1) { //filter by textbox
                            results += '<div class="col-lg-3 col-md-4 col-sm-6 col-xs-12"><img alt="tacos" ng-click="addCardClick($event)" data-id="' + $scope.cardData.curCard.Id + '" src="' + $scope.cardData.curCard.Url + '" /></div>';
                        }
                    }
                });

                var element = angular.element(document.querySelector('.selectCard'));
                var generated = element.html(results);
                $scope.cardsResponse = $compile(generated.contents())($scope);
            }
        } );
    </script>


    <div class="row">
        <div class="col-xs-12 col-offset-262">
            <h1>Building a @ViewData["className"] Deck</h1>
            <div id="overview" class="panel panel-default">
                <div class="panel-heading">Search for Cards: <input autofocus type="text" name="input" ng-model="txtSearch.text" ng-change="filterCards()" ng-trim="true" placeholder="Card Names" /> </div>
                <div class="panel-body">
                    <div class="row selectCard">

                    </div>
                </div>
            </div>
        </div>
        <div class="col-fixed-262">
            <div class="deckOptions"><button ng-click='saveDeckClick()' class="btn btn-primary btn-lg">Save</button> <a href="/Build/ConfirmDeleteDeck/" class="btn btn-danger btn-lg">Discard</a></div>
            <div id="overview" class="panel panel-default">
                <div class="panel-heading"><input type="text" name="input" ng-model="txtDeckName.text" ng-trim="true" placeholder="Deck Name" class="txtDeckName" value="@(((Deck)Session["deck"]).Title)"/></div>
                <div class="panel-body">
                    <div class="deckList">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>